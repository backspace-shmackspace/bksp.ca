{% extends "base.html" %}

{% block title %}{{ post.title or "Post Detail" }}{% endblock %}
{% block page_title %}Post Detail{% endblock %}
{% block page_subtitle %}{{ post.post_date }} Â· {{ post.post_type or "text post" }}{% endblock %}

{% block content %}

<!-- Back navigation -->
<div class="mb-6 flex items-center gap-4">
  <a href="/dashboard" class="inline-flex items-center gap-1.5 text-sm text-text-muted hover:text-text transition-colors">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
    </svg>
    Back to Dashboard
  </a>

  <div class="flex-1"></div>

  <!-- Prev / Next post navigation -->
  {% if prev_post %}
    <a href="/dashboard/posts/{{ prev_post.id }}"
       class="text-xs text-text-dim hover:text-accent transition-colors"
       title="{{ prev_post.title or 'Previous post' }}">
      &larr; Previous
    </a>
  {% endif %}
  {% if next_post %}
    <a href="/dashboard/posts/{{ next_post.id }}"
       class="text-xs text-text-dim hover:text-accent transition-colors"
       title="{{ next_post.title or 'Next post' }}">
      Next &rarr;
    </a>
  {% endif %}
</div>

<!-- Post header -->
<div class="bg-card rounded-xl border border-white/5 p-6 mb-6">
  <div class="flex items-start justify-between gap-4">
    <div class="flex-1 min-w-0">
      <div class="flex items-center gap-2 mb-1">
        {% if post.status == 'draft' %}
          <span class="inline-block text-xs font-medium px-2 py-0.5 rounded bg-blue-500/20 text-blue-400">Draft</span>
        {% elif post.status == 'published' %}
          <span class="inline-block text-xs font-medium px-2 py-0.5 rounded bg-success/20 text-success">Published</span>
        {% elif post.status == 'analytics_linked' %}
          <span class="inline-block text-xs font-medium px-2 py-0.5 rounded bg-amber-500/20 text-amber-400">Linked</span>
        {% elif post.status %}
          <span class="inline-block text-xs font-medium px-2 py-0.5 rounded bg-white/5 text-text-dim">{{ post.status }}</span>
        {% else %}
          <span class="inline-block text-xs font-medium px-2 py-0.5 rounded bg-white/5 text-text-dim">Imported</span>
        {% endif %}
      </div>
      <h2 class="text-lg font-semibold text-text leading-snug">
        {{ post.display_title }}
      </h2>
      <div class="flex items-center gap-3 mt-2 text-sm text-text-muted">
        <span class="font-mono">{{ post.post_date }}</span>
        {% if post.post_url %}
          <a href="{{ post.post_url }}" target="_blank" rel="noopener"
             class="text-accent/70 hover:text-accent transition-colors text-xs">
            view on LinkedIn &nearr;
          </a>
        {% endif %}
        {% if post.post_type %}
          <span class="bg-white/5 px-2 py-0.5 rounded text-xs">{{ post.post_type }}</span>
        {% endif %}
        {% if post.linkedin_post_id %}
          <span class="font-mono text-xs text-text-dim">ID: {{ post.linkedin_post_id }}</span>
        {% endif %}
      </div>
      <!-- Publish button for drafts -->
      {% if post.status == 'draft' %}
      <div class="mt-3">
        <a href="/dashboard/compose?post_id={{ post.id }}"
           class="inline-flex items-center gap-1.5 text-xs bg-accent/20 hover:bg-accent/30 text-accent px-3 py-1.5 rounded transition-colors">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
          </svg>
          Open in Composer to publish
        </a>
      </div>
      {% endif %}

      <!-- Draft linking -->
      <div class="flex items-center gap-2 mt-2">
        <label class="text-xs text-text-dim">Draft #</label>
        <input type="text" id="draftIdInput" value="{{ post.draft_id or '' }}"
               placeholder="e.g. 001"
               class="bg-white/5 border border-white/10 rounded px-2 py-0.5 text-xs text-text font-mono w-20
                      focus:outline-none focus:border-accent/50">
        <button onclick="saveDraftId()" id="saveDraftBtn"
                class="text-xs bg-accent/20 hover:bg-accent/30 text-accent px-2 py-0.5 rounded transition-colors">
          Link
        </button>
        <span id="draftSaveStatus" class="text-xs text-success hidden">Saved</span>
      </div>
    </div>
    <div class="text-right shrink-0">
      <div class="text-2xl font-mono font-semibold
                  {% if post.engagement_rate >= 0.05 %}text-success
                  {% elif post.engagement_rate >= 0.02 %}text-warning
                  {% else %}text-text-muted{% endif %}">
        {{ "%.1f%%"|format(post.engagement_rate * 100) }}
      </div>
      <div class="text-xs text-text-dim mt-0.5">engagement rate</div>
    </div>
  </div>
</div>

<!-- Metric cards with inline editing -->
<div class="bg-card rounded-xl border border-white/5 p-5 mb-6">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-sm font-medium text-text">Lifetime Metrics</h3>
    <div class="flex items-center gap-2">
      <button onclick="toggleMetricEdit()" id="editMetricsBtn"
              class="text-xs bg-white/5 hover:bg-white/10 text-text-dim px-2 py-1 rounded transition-colors">
        Edit
      </button>
      <button onclick="saveMetrics()" id="saveMetricsBtn"
              class="text-xs bg-accent/20 hover:bg-accent/30 text-accent px-2 py-1 rounded transition-colors hidden">
        Save
      </button>
      <span id="metricSaveStatus" class="text-xs text-success hidden">Saved</span>
    </div>
  </div>
  <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3">
    {% for field, label, value in [
      ("impressions", "Impressions", post.impressions),
      ("reactions",   "Reactions",   post.reactions),
      ("comments",    "Comments",    post.comments),
      ("shares",      "Shares",      post.shares),
      ("clicks",      "Clicks",      post.clicks),
    ] %}
    <div class="text-center">
      <div class="text-xl font-mono font-semibold text-text metric-display" data-field="{{ field }}">
        {{ "{:,}".format(value) }}
      </div>
      <input type="number" min="0" value="{{ value }}" data-field="{{ field }}"
             class="metric-input hidden w-full bg-white/5 border border-white/10 rounded px-2 py-1
                    text-center text-lg font-mono text-text focus:outline-none focus:border-accent/50">
      <div class="text-xs text-text-dim mt-1">{{ label }}</div>
    </div>
    {% endfor %}
  </div>
  <div class="mt-3 pt-3 border-t border-white/5 text-center">
    <span id="engRateDisplay" class="text-lg font-mono font-semibold
                {% if post.engagement_rate >= 0.05 %}text-success
                {% elif post.engagement_rate >= 0.02 %}text-warning
                {% else %}text-text-muted{% endif %}">
      {{ "%.1f%%"|format(post.engagement_rate * 100) }}
    </span>
    <div class="text-xs text-text-dim mt-0.5">engagement rate (auto-calculated)</div>
  </div>
</div>

<!-- Content Tags (cohort metadata) -->
<div class="bg-card rounded-xl border border-white/5 p-5 mb-6">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-sm font-medium text-text">Content Tags</h3>
    <div class="flex items-center gap-2">
      <span id="tagSaveStatus" class="text-xs text-success hidden">Saved</span>
      <button onclick="saveTags()" id="saveTagsBtn"
              class="text-xs bg-accent/20 hover:bg-accent/30 text-accent px-2 py-1 rounded transition-colors">
        Save Tags
      </button>
    </div>
  </div>
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">

    <!-- Topic -->
    <div>
      <label class="block text-xs text-text-dim mb-1">Topic</label>
      <input list="topicOptions" id="tagTopic" name="topic"
             value="{{ post.topic or '' }}"
             placeholder="e.g. risk-management"
             class="w-full bg-white/5 border border-white/10 rounded px-3 py-1.5 text-sm text-text
                    focus:outline-none focus:border-accent/50">
      <datalist id="topicOptions">
        <option value="risk-management">
        <option value="devsecops">
        <option value="psirt">
        <option value="htb-writeup">
        <option value="ai-agents">
        <option value="career">
        <option value="leadership">
        <option value="security-culture">
        <option value="vulnerability-management">
        <option value="compliance">
      </datalist>
    </div>

    <!-- Format -->
    <div>
      <label class="block text-xs text-text-dim mb-1">Format</label>
      <select id="tagFormat" name="content_format"
              class="w-full bg-white/5 border border-white/10 rounded px-3 py-1.5 text-sm text-text
                     focus:outline-none focus:border-accent/50 cursor-pointer">
        <option value="">-- none --</option>
        <option value="story"         {% if post.content_format == 'story' %}selected{% endif %}>Story</option>
        <option value="listicle"      {% if post.content_format == 'listicle' %}selected{% endif %}>Listicle</option>
        <option value="hot-take"      {% if post.content_format == 'hot-take' %}selected{% endif %}>Hot Take</option>
        <option value="tutorial"      {% if post.content_format == 'tutorial' %}selected{% endif %}>Tutorial</option>
        <option value="case-study"    {% if post.content_format == 'case-study' %}selected{% endif %}>Case Study</option>
        <option value="data-analysis" {% if post.content_format == 'data-analysis' %}selected{% endif %}>Data Analysis</option>
        <option value="question"      {% if post.content_format == 'question' %}selected{% endif %}>Question</option>
        <option value="announcement"  {% if post.content_format == 'announcement' %}selected{% endif %}>Announcement</option>
      </select>
    </div>

    <!-- Hook Style -->
    <div>
      <label class="block text-xs text-text-dim mb-1">Hook Style</label>
      <select id="tagHookStyle" name="hook_style"
              class="w-full bg-white/5 border border-white/10 rounded px-3 py-1.5 text-sm text-text
                     focus:outline-none focus:border-accent/50 cursor-pointer">
        <option value="">-- none --</option>
        <option value="question"       {% if post.hook_style == 'question' %}selected{% endif %}>Question</option>
        <option value="statistic"      {% if post.hook_style == 'statistic' %}selected{% endif %}>Statistic</option>
        <option value="contrarian"     {% if post.hook_style == 'contrarian' %}selected{% endif %}>Contrarian</option>
        <option value="personal-story" {% if post.hook_style == 'personal-story' %}selected{% endif %}>Personal Story</option>
        <option value="news-hook"      {% if post.hook_style == 'news-hook' %}selected{% endif %}>News Hook</option>
        <option value="bold-claim"     {% if post.hook_style == 'bold-claim' %}selected{% endif %}>Bold Claim</option>
        <option value="how-to"         {% if post.hook_style == 'how-to' %}selected{% endif %}>How-To</option>
        <option value="mistake-learned"{% if post.hook_style == 'mistake-learned' %}selected{% endif %}>Mistake Learned</option>
      </select>
    </div>

    <!-- Length -->
    <div>
      <label class="block text-xs text-text-dim mb-1">Length</label>
      <select id="tagLength" name="length_bucket"
              class="w-full bg-white/5 border border-white/10 rounded px-3 py-1.5 text-sm text-text
                     focus:outline-none focus:border-accent/50 cursor-pointer">
        <option value="">-- none --</option>
        <option value="short"  {% if post.length_bucket == 'short' %}selected{% endif %}>Short (&lt;500 chars)</option>
        <option value="medium" {% if post.length_bucket == 'medium' %}selected{% endif %}>Medium (500-1500)</option>
        <option value="long"   {% if post.length_bucket == 'long' %}selected{% endif %}>Long (&gt;1500)</option>
      </select>
    </div>

    <!-- Post Hour -->
    <div>
      <label class="block text-xs text-text-dim mb-1">Post Hour (0-23)</label>
      <input type="number" id="tagPostHour" name="post_hour" min="0" max="23"
             value="{{ post.post_hour if post.post_hour is not none else '' }}"
             placeholder="e.g. 9"
             class="w-full bg-white/5 border border-white/10 rounded px-3 py-1.5 text-sm text-text font-mono
                    focus:outline-none focus:border-accent/50">
    </div>

  </div>
</div>

<!-- Post content (if stored locally) -->
{% if post.content %}
<div class="bg-card rounded-xl border border-white/5 p-5 mb-6">
  <h3 class="text-sm font-medium text-text mb-3">Post Content</h3>
  <pre class="text-sm text-text-muted leading-relaxed whitespace-pre-wrap font-mono">{{ post.content }}</pre>
</div>
{% endif %}

<!-- Additional per-post metrics (from per-post XLSX export) -->
{% if post.saves or post.sends or post.profile_views or post.followers_gained or post.reposts %}
<div class="bg-card rounded-xl border border-white/5 p-5 mb-6">
  <h3 class="text-sm font-medium text-text mb-4">Per-Post Metrics</h3>
  <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3">
    {% for label, value in [
      ("Saves",            post.saves),
      ("Sends",            post.sends),
      ("Profile Views",    post.profile_views),
      ("Followers Gained", post.followers_gained),
      ("Reposts",          post.reposts),
    ] %}
    {% if value is not none %}
    <div class="text-center">
      <div class="text-xl font-mono font-semibold text-text">{{ "{:,}".format(value) }}</div>
      <div class="text-xs text-text-dim mt-1">{{ label }}</div>
    </div>
    {% endif %}
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- Per-post demographics (from per-post XLSX export) -->
{% if demo_by_category %}
<div class="bg-card rounded-xl border border-white/5 p-5 mb-6">
  <h3 class="text-sm font-medium text-text mb-4">Audience Demographics (this post)</h3>
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
    {% for category, rows in demo_by_category.items() %}
    <div>
      <h4 class="text-xs font-medium text-text-dim uppercase tracking-wide mb-3">
        {{ category.replace("_", " ").title() }}
      </h4>
      <div class="space-y-2">
        {% for row in rows[:10] %}
        <div class="flex items-center gap-2">
          <span class="text-xs text-text-muted w-40 truncate shrink-0">{{ row.value }}</span>
          <div class="flex-1 bg-white/5 rounded-full h-1.5 overflow-hidden">
            <div class="bg-accent h-1.5 rounded-full" style="width: {{ [row.percentage, 100] | min }}%"></div>
          </div>
          <span class="text-xs font-mono text-text-dim w-10 text-right shrink-0">
            {{ "%.0f%%"|format(row.percentage) }}
          </span>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- Daily trend chart (if daily data is available) -->
{% if daily_metrics %}
<div class="bg-card rounded-xl border border-white/5 p-5 mb-6">
  <h3 class="text-sm font-medium text-text mb-4">Daily Impression Trend</h3>
  <div class="h-48">
    <canvas id="postDailyChart"></canvas>
  </div>
</div>
{% endif %}

{% endblock %}


{% block scripts %}
<script src="/static/js/charts.js"></script>
<script>
  const postConfig = {
    impressions: {{ post.impressions }},
    engagements: {{ post.reactions }},
    {% if daily_metrics %}
    dailyLabels: {{ daily_metrics | map(attribute='metric_date') | map('string') | list | tojson }},
    dailyValues: {{ daily_metrics | map(attribute='impressions') | list | tojson }},
    {% else %}
    dailyLabels: [],
    dailyValues: [],
    {% endif %}
  };
  initPostDetail(postConfig);

  async function saveDraftId() {
    const input = document.getElementById("draftIdInput");
    const status = document.getElementById("draftSaveStatus");
    const btn = document.getElementById("saveDraftBtn");
    const draftId = input.value.trim();
    btn.disabled = true;
    btn.textContent = "...";
    try {
      const resp = await fetch(`/api/posts/{{ post.id }}?draft_id=${encodeURIComponent(draftId)}`, {method: "PATCH"});
      if (resp.ok) {
        const data = await resp.json();
        status.classList.remove("hidden");
        status.textContent = "Saved";
        // Update the page title
        document.querySelector("h2").textContent = data.display_title;
        setTimeout(() => status.classList.add("hidden"), 2000);
      } else {
        status.classList.remove("hidden");
        status.textContent = "Error";
        status.classList.replace("text-success", "text-warning");
      }
    } catch(e) {
      status.classList.remove("hidden");
      status.textContent = "Failed";
    }
    btn.disabled = false;
    btn.textContent = "Link";
  }

  function toggleMetricEdit() {
    const displays = document.querySelectorAll(".metric-display");
    const inputs = document.querySelectorAll(".metric-input");
    const editBtn = document.getElementById("editMetricsBtn");
    const saveBtn = document.getElementById("saveMetricsBtn");
    const isEditing = !inputs[0].classList.contains("hidden");
    displays.forEach(el => el.classList.toggle("hidden"));
    inputs.forEach(el => el.classList.toggle("hidden"));
    editBtn.classList.toggle("hidden");
    saveBtn.classList.toggle("hidden");
    if (!isEditing) inputs[0].focus();
  }

  async function saveTags() {
    const status = document.getElementById("tagSaveStatus");
    const btn = document.getElementById("saveTagsBtn");
    btn.disabled = true;
    btn.textContent = "...";

    const params = new URLSearchParams();
    const topic = document.getElementById("tagTopic").value;
    const format = document.getElementById("tagFormat").value;
    const hookStyle = document.getElementById("tagHookStyle").value;
    const length = document.getElementById("tagLength").value;
    const postHour = document.getElementById("tagPostHour").value;

    params.set("topic", topic);
    params.set("content_format", format);
    params.set("hook_style", hookStyle);
    params.set("length_bucket", length);
    if (postHour !== "") {
      params.set("post_hour", postHour);
    }

    try {
      const resp = await fetch(`/api/posts/{{ post.id }}?${params}`, { method: "PATCH" });
      if (resp.ok) {
        status.classList.remove("hidden");
        status.textContent = "Saved";
        status.className = "text-xs text-success";
        setTimeout(() => status.classList.add("hidden"), 2000);
      } else {
        status.classList.remove("hidden");
        status.textContent = "Error";
        status.className = "text-xs text-warning";
      }
    } catch (e) {
      status.classList.remove("hidden");
      status.textContent = "Failed";
      status.className = "text-xs text-danger";
    }
    btn.disabled = false;
    btn.textContent = "Save Tags";
  }

  async function saveMetrics() {
    const inputs = document.querySelectorAll(".metric-input");
    const status = document.getElementById("metricSaveStatus");
    const params = new URLSearchParams();
    inputs.forEach(input => params.set(input.dataset.field, input.value));
    try {
      const resp = await fetch(`/api/posts/{{ post.id }}?${params}`, {method: "PATCH"});
      if (resp.ok) {
        const data = await resp.json();
        document.querySelectorAll(".metric-display").forEach(el => {
          const val = data[el.dataset.field];
          el.textContent = val.toLocaleString();
        });
        const rate = (data.engagement_rate * 100).toFixed(1) + "%";
        document.getElementById("engRateDisplay").textContent = rate;
        toggleMetricEdit();
        status.classList.remove("hidden");
        status.textContent = "Saved";
        setTimeout(() => status.classList.add("hidden"), 2000);
      }
    } catch(e) {
      status.classList.remove("hidden");
      status.textContent = "Failed";
    }
  }
</script>
{% endblock %}
