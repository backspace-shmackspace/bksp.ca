{% extends "base.html" %}

{% block title %}{{ post.title or "Post Detail" }}{% endblock %}
{% block page_title %}Post Detail{% endblock %}
{% block page_subtitle %}{{ post.post_date }} Â· {{ post.post_type or "unknown type" }}{% endblock %}

{% block content %}

<!-- Back navigation -->
<div class="mb-6 flex items-center gap-4">
  <a href="/dashboard" class="inline-flex items-center gap-1.5 text-sm text-text-muted hover:text-text transition-colors">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
    </svg>
    Back to Dashboard
  </a>

  <div class="flex-1"></div>

  <!-- Prev / Next post navigation -->
  {% if prev_post %}
    <a href="/dashboard/posts/{{ prev_post.id }}"
       class="text-xs text-text-dim hover:text-accent transition-colors"
       title="{{ prev_post.title or 'Previous post' }}">
      &larr; Previous
    </a>
  {% endif %}
  {% if next_post %}
    <a href="/dashboard/posts/{{ next_post.id }}"
       class="text-xs text-text-dim hover:text-accent transition-colors"
       title="{{ next_post.title or 'Next post' }}">
      Next &rarr;
    </a>
  {% endif %}
</div>

<!-- Post header -->
<div class="bg-card rounded-xl border border-white/5 p-6 mb-6">
  <div class="flex items-start justify-between gap-4">
    <div class="flex-1 min-w-0">
      <h2 class="text-lg font-semibold text-text leading-snug">
        {{ post.title or "(no title captured)" }}
      </h2>
      <div class="flex items-center gap-3 mt-2 text-sm text-text-muted">
        <span class="font-mono">{{ post.post_date }}</span>
        {% if post.post_type %}
          <span class="bg-white/5 px-2 py-0.5 rounded text-xs">{{ post.post_type }}</span>
        {% endif %}
        {% if post.linkedin_post_id %}
          <span class="font-mono text-xs text-text-dim">ID: {{ post.linkedin_post_id }}</span>
        {% endif %}
      </div>
    </div>
    <div class="text-right shrink-0">
      <div class="text-2xl font-mono font-semibold
                  {% if post.engagement_rate >= 0.05 %}text-success
                  {% elif post.engagement_rate >= 0.02 %}text-warning
                  {% else %}text-text-muted{% endif %}">
        {{ "%.1f%%"|format(post.engagement_rate * 100) }}
      </div>
      <div class="text-xs text-text-dim mt-0.5">engagement rate</div>
    </div>
  </div>
</div>

<!-- Metric breakdown cards -->
<div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 mb-6">
  {% for label, value, color in [
    ("Impressions",      post.impressions,      "text-text"),
    ("Members Reached",  post.members_reached,  "text-text"),
    ("Reactions",        post.reactions,        "text-success"),
    ("Comments",         post.comments,         "text-accent"),
    ("Shares",           post.shares,           "text-warning"),
    ("Clicks",           post.clicks,           "text-text-muted"),
  ] %}
  <div class="bg-card rounded-xl border border-white/5 p-4 text-center">
    <div class="text-xl font-mono font-semibold {{ color }}">
      {{ "{:,}".format(value) }}
    </div>
    <div class="text-xs text-text-dim mt-1">{{ label }}</div>
  </div>
  {% endfor %}
</div>

<!-- Daily trend chart (if daily data is available) -->
{% if daily_metrics %}
<div class="bg-card rounded-xl border border-white/5 p-5 mb-6">
  <h3 class="text-sm font-medium text-text mb-4">Daily Impression Trend</h3>
  <div class="h-48">
    <canvas id="postDailyChart"></canvas>
  </div>
</div>
{% endif %}

<!-- Engagement breakdown chart -->
<div class="bg-card rounded-xl border border-white/5 p-5">
  <h3 class="text-sm font-medium text-text mb-4">Engagement Breakdown</h3>
  <div class="h-48">
    <canvas id="postEngagementChart"></canvas>
  </div>
</div>

{% endblock %}


{% block scripts %}
<script src="/static/js/charts.js"></script>
<script>
  const postConfig = {
    impressions: {{ post.impressions }},
    reactions:   {{ post.reactions }},
    comments:    {{ post.comments }},
    shares:      {{ post.shares }},
    clicks:      {{ post.clicks }},
    {% if daily_metrics %}
    dailyLabels: {{ daily_metrics | map(attribute='metric_date') | map('string') | list | tojson }},
    dailyValues: {{ daily_metrics | map(attribute='impressions') | list | tojson }},
    {% else %}
    dailyLabels: [],
    dailyValues: [],
    {% endif %}
  };
  initPostDetail(postConfig);
</script>
{% endblock %}
