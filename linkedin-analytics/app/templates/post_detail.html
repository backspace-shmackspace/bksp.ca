{% extends "base.html" %}

{% block title %}{{ post.title or "Post Detail" }}{% endblock %}
{% block page_title %}Post Detail{% endblock %}
{% block page_subtitle %}{{ post.post_date }} Â· {{ post.post_type or "unknown type" }}{% endblock %}

{% block content %}

<!-- Back navigation -->
<div class="mb-6 flex items-center gap-4">
  <a href="/dashboard" class="inline-flex items-center gap-1.5 text-sm text-text-muted hover:text-text transition-colors">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
    </svg>
    Back to Dashboard
  </a>

  <div class="flex-1"></div>

  <!-- Prev / Next post navigation -->
  {% if prev_post %}
    <a href="/dashboard/posts/{{ prev_post.id }}"
       class="text-xs text-text-dim hover:text-accent transition-colors"
       title="{{ prev_post.title or 'Previous post' }}">
      &larr; Previous
    </a>
  {% endif %}
  {% if next_post %}
    <a href="/dashboard/posts/{{ next_post.id }}"
       class="text-xs text-text-dim hover:text-accent transition-colors"
       title="{{ next_post.title or 'Next post' }}">
      Next &rarr;
    </a>
  {% endif %}
</div>

<!-- Post header -->
<div class="bg-card rounded-xl border border-white/5 p-6 mb-6">
  <div class="flex items-start justify-between gap-4">
    <div class="flex-1 min-w-0">
      <h2 class="text-lg font-semibold text-text leading-snug">
        {{ post.display_title }}
      </h2>
      <div class="flex items-center gap-3 mt-2 text-sm text-text-muted">
        <span class="font-mono">{{ post.post_date }}</span>
        {% if post.post_url %}
          <a href="{{ post.post_url }}" target="_blank" rel="noopener"
             class="text-accent/70 hover:text-accent transition-colors text-xs">
            view on LinkedIn &nearr;
          </a>
        {% endif %}
        {% if post.post_type %}
          <span class="bg-white/5 px-2 py-0.5 rounded text-xs">{{ post.post_type }}</span>
        {% endif %}
        {% if post.linkedin_post_id %}
          <span class="font-mono text-xs text-text-dim">ID: {{ post.linkedin_post_id }}</span>
        {% endif %}
      </div>
      <!-- Draft linking -->
      <div class="flex items-center gap-2 mt-2">
        <label class="text-xs text-text-dim">Draft #</label>
        <input type="text" id="draftIdInput" value="{{ post.draft_id or '' }}"
               placeholder="e.g. 001"
               class="bg-white/5 border border-white/10 rounded px-2 py-0.5 text-xs text-text font-mono w-20
                      focus:outline-none focus:border-accent/50">
        <button onclick="saveDraftId()" id="saveDraftBtn"
                class="text-xs bg-accent/20 hover:bg-accent/30 text-accent px-2 py-0.5 rounded transition-colors">
          Link
        </button>
        <span id="draftSaveStatus" class="text-xs text-success hidden">Saved</span>
      </div>
    </div>
    <div class="text-right shrink-0">
      <div class="text-2xl font-mono font-semibold
                  {% if post.engagement_rate >= 0.05 %}text-success
                  {% elif post.engagement_rate >= 0.02 %}text-warning
                  {% else %}text-text-muted{% endif %}">
        {{ "%.1f%%"|format(post.engagement_rate * 100) }}
      </div>
      <div class="text-xs text-text-dim mt-0.5">engagement rate</div>
    </div>
  </div>
</div>

<!-- Metric cards with inline editing -->
<div class="bg-card rounded-xl border border-white/5 p-5 mb-6">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-sm font-medium text-text">Lifetime Metrics</h3>
    <div class="flex items-center gap-2">
      <button onclick="toggleMetricEdit()" id="editMetricsBtn"
              class="text-xs bg-white/5 hover:bg-white/10 text-text-dim px-2 py-1 rounded transition-colors">
        Edit
      </button>
      <button onclick="saveMetrics()" id="saveMetricsBtn"
              class="text-xs bg-accent/20 hover:bg-accent/30 text-accent px-2 py-1 rounded transition-colors hidden">
        Save
      </button>
      <span id="metricSaveStatus" class="text-xs text-success hidden">Saved</span>
    </div>
  </div>
  <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3">
    {% for field, label, value in [
      ("impressions", "Impressions", post.impressions),
      ("reactions",   "Reactions",   post.reactions),
      ("comments",    "Comments",    post.comments),
      ("shares",      "Shares",      post.shares),
      ("clicks",      "Clicks",      post.clicks),
    ] %}
    <div class="text-center">
      <div class="text-xl font-mono font-semibold text-text metric-display" data-field="{{ field }}">
        {{ "{:,}".format(value) }}
      </div>
      <input type="number" min="0" value="{{ value }}" data-field="{{ field }}"
             class="metric-input hidden w-full bg-white/5 border border-white/10 rounded px-2 py-1
                    text-center text-lg font-mono text-text focus:outline-none focus:border-accent/50">
      <div class="text-xs text-text-dim mt-1">{{ label }}</div>
    </div>
    {% endfor %}
  </div>
  <div class="mt-3 pt-3 border-t border-white/5 text-center">
    <span id="engRateDisplay" class="text-lg font-mono font-semibold
                {% if post.engagement_rate >= 0.05 %}text-success
                {% elif post.engagement_rate >= 0.02 %}text-warning
                {% else %}text-text-muted{% endif %}">
      {{ "%.1f%%"|format(post.engagement_rate * 100) }}
    </span>
    <div class="text-xs text-text-dim mt-0.5">engagement rate (auto-calculated)</div>
  </div>
</div>

<!-- Daily trend chart (if daily data is available) -->
{% if daily_metrics %}
<div class="bg-card rounded-xl border border-white/5 p-5 mb-6">
  <h3 class="text-sm font-medium text-text mb-4">Daily Impression Trend</h3>
  <div class="h-48">
    <canvas id="postDailyChart"></canvas>
  </div>
</div>
{% endif %}

{% endblock %}


{% block scripts %}
<script src="/static/js/charts.js"></script>
<script>
  const postConfig = {
    impressions: {{ post.impressions }},
    engagements: {{ post.reactions }},
    {% if daily_metrics %}
    dailyLabels: {{ daily_metrics | map(attribute='metric_date') | map('string') | list | tojson }},
    dailyValues: {{ daily_metrics | map(attribute='impressions') | list | tojson }},
    {% else %}
    dailyLabels: [],
    dailyValues: [],
    {% endif %}
  };
  initPostDetail(postConfig);

  async function saveDraftId() {
    const input = document.getElementById("draftIdInput");
    const status = document.getElementById("draftSaveStatus");
    const btn = document.getElementById("saveDraftBtn");
    const draftId = input.value.trim();
    btn.disabled = true;
    btn.textContent = "...";
    try {
      const resp = await fetch(`/api/posts/{{ post.id }}?draft_id=${encodeURIComponent(draftId)}`, {method: "PATCH"});
      if (resp.ok) {
        const data = await resp.json();
        status.classList.remove("hidden");
        status.textContent = "Saved";
        // Update the page title
        document.querySelector("h2").textContent = data.display_title;
        setTimeout(() => status.classList.add("hidden"), 2000);
      } else {
        status.classList.remove("hidden");
        status.textContent = "Error";
        status.classList.replace("text-success", "text-warning");
      }
    } catch(e) {
      status.classList.remove("hidden");
      status.textContent = "Failed";
    }
    btn.disabled = false;
    btn.textContent = "Link";
  }

  function toggleMetricEdit() {
    const displays = document.querySelectorAll(".metric-display");
    const inputs = document.querySelectorAll(".metric-input");
    const editBtn = document.getElementById("editMetricsBtn");
    const saveBtn = document.getElementById("saveMetricsBtn");
    const isEditing = !inputs[0].classList.contains("hidden");
    displays.forEach(el => el.classList.toggle("hidden"));
    inputs.forEach(el => el.classList.toggle("hidden"));
    editBtn.classList.toggle("hidden");
    saveBtn.classList.toggle("hidden");
    if (!isEditing) inputs[0].focus();
  }

  async function saveMetrics() {
    const inputs = document.querySelectorAll(".metric-input");
    const status = document.getElementById("metricSaveStatus");
    const params = new URLSearchParams();
    inputs.forEach(input => params.set(input.dataset.field, input.value));
    try {
      const resp = await fetch(`/api/posts/{{ post.id }}?${params}`, {method: "PATCH"});
      if (resp.ok) {
        const data = await resp.json();
        document.querySelectorAll(".metric-display").forEach(el => {
          const val = data[el.dataset.field];
          el.textContent = val.toLocaleString();
        });
        const rate = (data.engagement_rate * 100).toFixed(1) + "%";
        document.getElementById("engRateDisplay").textContent = rate;
        toggleMetricEdit();
        status.classList.remove("hidden");
        status.textContent = "Saved";
        setTimeout(() => status.classList.add("hidden"), 2000);
      }
    } catch(e) {
      status.classList.remove("hidden");
      status.textContent = "Failed";
    }
  }
</script>
{% endblock %}
