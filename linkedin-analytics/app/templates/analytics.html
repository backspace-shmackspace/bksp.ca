{% extends "base.html" %}

{% block title %}Analytics{% endblock %}
{% block page_title %}Engagement Analytics{% endblock %}
{% block page_subtitle %}Quality-weighted engagement trends and cohort breakdown{% endblock %}

{% block content %}

{% if not has_data %}
<!-- Empty state -->
<div class="flex flex-col items-center justify-center py-24 text-center">
  <svg class="w-12 h-12 text-text-dim mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
          d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
  </svg>
  <p class="text-text-muted text-sm">No post data yet.</p>
  <p class="text-text-dim text-xs mt-1">Import a LinkedIn export to get started.</p>
  <a href="/upload" class="mt-4 inline-flex items-center gap-1.5 bg-accent hover:bg-accent-hover text-white text-xs font-medium px-3 py-1.5 rounded-lg transition-colors">
    Import Export
  </a>
</div>
{% else %}

<!-- Baseline vs Last 30 Days KPI cards -->
<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="kpiCards">
  <!-- Populated by initAnalytics -->
  <div class="bg-card rounded-xl border border-white/5 p-4 animate-pulse">
    <div class="h-4 bg-white/5 rounded w-24 mb-3"></div>
    <div class="h-7 bg-white/5 rounded w-16"></div>
  </div>
  <div class="bg-card rounded-xl border border-white/5 p-4 animate-pulse">
    <div class="h-4 bg-white/5 rounded w-24 mb-3"></div>
    <div class="h-7 bg-white/5 rounded w-16"></div>
  </div>
  <div class="bg-card rounded-xl border border-white/5 p-4 animate-pulse">
    <div class="h-4 bg-white/5 rounded w-24 mb-3"></div>
    <div class="h-7 bg-white/5 rounded w-16"></div>
  </div>
  <div class="bg-card rounded-xl border border-white/5 p-4 animate-pulse">
    <div class="h-4 bg-white/5 rounded w-24 mb-3"></div>
    <div class="h-7 bg-white/5 rounded w-16"></div>
  </div>
</div>

<!-- Engagement Rate Over Time + Rolling Average + Top 10% Threshold -->
<div class="bg-card rounded-xl border border-white/5 p-5 mb-6">
  <div class="flex items-center justify-between mb-1">
    <h3 class="text-sm font-medium text-text">Engagement Rate Over Time</h3>
    <div class="flex items-center gap-4 text-xs text-text-muted">
      <span class="flex items-center gap-1.5">
        <span class="inline-block w-3 h-0.5 bg-accent rounded"></span>
        Engagement rate
      </span>
      <span class="flex items-center gap-1.5">
        <span class="inline-block w-3 h-0.5 bg-success rounded"></span>
        5-post rolling avg
      </span>
      <span class="flex items-center gap-1.5">
        <span class="inline-block w-3 h-0.5 bg-warning rounded" style="border-top: 2px dashed #f59e0b; height: 0;"></span>
        Top 10% threshold
      </span>
    </div>
  </div>
  <p class="text-xs text-text-dim mb-4">Each point is a post. Rolling average smooths algorithm variance.</p>
  <div class="h-64">
    <canvas id="engagementTimeChart"></canvas>
  </div>
</div>

<!-- Monthly Median Engagement Rate -->
<div class="bg-card rounded-xl border border-white/5 p-5 mb-6">
  <h3 class="text-sm font-medium text-text mb-1">Median Engagement Rate by Month</h3>
  <p class="text-xs text-text-dim mb-4">Median is more robust to outliers than average. Post count shown above each bar.</p>
  <div class="h-56">
    <canvas id="monthlyMedianChart"></canvas>
  </div>
</div>

<!-- Cohort Breakdown -->
<div class="bg-card rounded-xl border border-white/5 p-5">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h3 class="text-sm font-medium text-text">Cohort Breakdown</h3>
      <p class="text-xs text-text-dim mt-0.5">Only posts with the selected field tagged are included.</p>
    </div>
    <select id="cohortDimension"
            class="bg-white/5 border border-white/10 rounded px-3 py-1.5 text-sm text-text
                   focus:outline-none focus:border-accent/50 cursor-pointer">
      <option value="topic">Topic</option>
      <option value="content_format">Format</option>
      <option value="hook_style">Hook Style</option>
      <option value="length_bucket">Length</option>
      <option value="post_hour">Post Hour</option>
    </select>
  </div>

  <!-- Cohort table -->
  <div id="cohortTableWrapper">
    <table class="w-full text-sm" id="cohortTable">
      <thead>
        <tr class="text-left text-xs text-text-dim border-b border-white/5">
          <th class="pb-2 font-medium">Value</th>
          <th class="pb-2 font-medium text-right">Posts</th>
          <th class="pb-2 font-medium text-right">Avg Engagement</th>
          <th class="pb-2 font-medium text-right">Avg Weighted Score</th>
          <th class="pb-2 font-medium text-right">Median Engagement</th>
          <th class="pb-2 font-medium">Best Post</th>
        </tr>
      </thead>
      <tbody id="cohortTableBody" class="divide-y divide-white/5">
        <tr>
          <td colspan="6" class="py-6 text-center text-text-dim text-xs">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

{% endif %}

{% endblock %}


{% block scripts %}
{% if has_data %}
<script src="/static/js/charts.js"></script>
<script>
  initAnalytics({ defaultDays: 365 });
</script>
{% endif %}
{% endblock %}
