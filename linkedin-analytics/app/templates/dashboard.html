{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Content performance overview{% endblock %}

{% block header_actions %}
  <div class="flex items-center gap-2">
    <span class="text-xs text-text-dim">Period:</span>
    {% for d in [7, 30, 90] %}
      <a
        href="/dashboard?days={{ d }}"
        class="text-xs px-2.5 py-1 rounded-md transition-colors
               {% if days == d %}bg-accent text-white{% else %}bg-white/5 text-text-muted hover:bg-white/10{% endif %}"
      >{{ d }}d</a>
    {% endfor %}
  </div>
{% endblock %}

{% block content %}

{% if not has_data %}
  <!-- Empty state -->
  <div class="flex flex-col items-center justify-center py-24 text-center">
    <div class="w-16 h-16 bg-card rounded-2xl flex items-center justify-center mb-5 border border-white/5">
      <svg class="w-8 h-8 text-text-dim" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
      </svg>
    </div>
    <h2 class="text-lg font-semibold text-text mb-2">No data yet</h2>
    <p class="text-text-muted text-sm max-w-sm mb-6">
      Export your LinkedIn analytics from
      <span class="font-mono text-accent">linkedin.com/analytics/creator/content/</span>
      and upload the file to get started.
    </p>
    <a
      href="/upload"
      class="inline-flex items-center gap-2 bg-accent hover:bg-accent-hover text-white text-sm font-medium px-4 py-2 rounded-lg transition-colors"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
      </svg>
      Upload LinkedIn Export
    </a>
  </div>

{% else %}

  <!-- KPI cards -->
  <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    {% with label="Impressions ("+days|string+"d)", value="{:,}".format(total_impressions), sublabel="Account-level reach", accent=true %}
      {% include "_partials/kpi_card.html" %}
    {% endwith %}

    {% with label="Avg. Engagement Rate", value="%.1f%%"|format(avg_engagement_rate), sublabel="(reactions+comments+shares)/impressions", accent=false %}
      {% include "_partials/kpi_card.html" %}
    {% endwith %}

    {% with label="Total Followers", value="{:,}".format(total_followers), sublabel="Current count", accent=false %}
      {% include "_partials/kpi_card.html" %}
    {% endwith %}

    {% with label="Posts Tracked", value=total_posts|string, sublabel="All time", accent=false %}
      {% include "_partials/kpi_card.html" %}
    {% endwith %}
  </div>

  <!-- Charts row -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mb-8">

    <!-- Impressions over time -->
    <div class="bg-card rounded-xl border border-white/5 p-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-sm font-medium text-text">Impressions Over Time</h3>
        <div class="flex gap-2" id="metric-tabs">
          {% for m in ["impressions", "reactions", "comments", "shares"] %}
            <button
              data-metric="{{ m }}"
              class="metric-btn text-xs px-2 py-1 rounded transition-colors
                     {% if m == 'impressions' %}bg-accent text-white{% else %}bg-white/5 text-text-muted hover:bg-white/10{% endif %}"
            >{{ m | capitalize }}</button>
          {% endfor %}
        </div>
      </div>
      <div class="h-48">
        <canvas id="impressionsChart"></canvas>
      </div>
    </div>

    <!-- Engagement rate over time (per post) -->
    <div class="bg-card rounded-xl border border-white/5 p-5">
      <h3 class="text-sm font-medium text-text mb-4">Engagement Rate by Post</h3>
      <div class="h-48">
        <canvas id="engagementChart"></canvas>
      </div>
    </div>

  </div>

  <!-- Recent posts table -->
  <div class="bg-card rounded-xl border border-white/5 p-5">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-sm font-medium text-text">Recent Posts</h3>
      <a href="/api/posts?limit=100" class="text-xs text-text-dim hover:text-accent transition-colors">
        View all via API
      </a>
    </div>
    {% with posts=recent_posts, show_links=true %}
      {% include "_partials/post_table.html" %}
    {% endwith %}
  </div>

{% endif %}

{% endblock %}


{% block scripts %}
<script src="/static/js/charts.js"></script>
{% if has_data %}
<script>
  // Pass server-rendered data to charts.js
  const dashboardConfig = {
    days: {{ days }},
    posts: {{ recent_posts | map(attribute='id') | list | tojson }},
    postLabels: {{ recent_posts | map(attribute='display_title') | list | tojson }},
    postEngagement: {{ recent_posts | map(attribute='engagement_rate') | list | tojson }},
  };
  initDashboard(dashboardConfig);
</script>
{% endif %}
{% endblock %}
